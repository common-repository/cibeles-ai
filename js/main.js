class caip_Functions{eliminaSignosPuntuacion(a){a.forEach((b,c)=>{a[c]=b.replace(/\?/g,"");a[c]=a[c].replace(/['"]+/g,"");a[c]=a[c].split(" ... ").join(", ");a[c]=a[c].split("\u00a1").join("");a[c]=a[c].split("!").join(". ");a[c]=a[c].split("\u00bf").join("");a[c]=a[c].split("?").join(". ");a[c]=a[c].trim();a[c]=a[c].replace(/\.jQuery/,"");a[c]=a[c].replace(/\s{2,}/g," ")});return a}convierteStringToArray(a){a=a.trim();return a.replace(/^\d+\.\s*/gm,"").split("\n")}get_todo_contenido(){if(tinyMCE&&
null!=tinyMCE.activeEditor){let b=tinymce.editors.content.getContent();var a=document.createElement("div");a.innerHTML=b;b=a.textContent;return b=b.trim()}alert(__("Hay un problema con el edior tinyMCE, aseg\u00farese que est\u00e1 en modo visual","cibeles-ai"));return!1}copiar(a){var b=document.createElement("input");b.value=a;document.body.appendChild(b);b.select();document.execCommand("copy");document.body.removeChild(b)}};class caip_Button{constructor(a){this.animateButtonId="div_button_"+a;this.checkedIcon='<i class="fa fa-check" aria-hidden="true"></i>';this.powerIcon='<i class="fa fa-superpowers" aria-hidden="true"></i>'}animateButton(){jQuery("#"+this.animateButtonId+" i").addClass("fa-spin");jQuery("#"+this.animateButtonId).css("background","#183954")}deanimateButton(){jQuery("#"+this.animateButtonId+" i").removeClass("fa-spin");jQuery("#"+this.animateButtonId).css("background","#2271b1")}changeIconToChecked(a=
!1){!1===a&&(a="#"+this.animateButtonId);jQuery(a).find("a i").remove();setTimeout(()=>{jQuery(a).find("a").append(this.checkedIcon)},50)}changeIconToPower(a=!1){!1===a&&(a="#"+this.animateButtonId);jQuery(a).find("a i").remove();setTimeout(()=>{jQuery(a).find("a").append(this.powerIcon);this.animateButton()},50)}};class caip_Action{constructor(){this.cantidadPalabras=0;this.functions=new caip_Functions;this.contenido="";this.tokens=2E3;this.htmlresult=this.responseText="";this.launched=!1;this.loadingDiv=document.createElement("div");this.loadingDiv.id="loadingDiv";this.loadingDiv.innerHTML="<div class='loading-indicator'></div>";this.responseStartsWhith=""}initFunction(){this.contenido=this.functions.get_todo_contenido();this.input=this.prompt+this.contenido+"\n\n"+this.responseStartsWhith;return""==this.contenido?
(setTimeout(()=>{jQuery("#TB_closeWindowButton").click();alert(this.alertSinContenido)},50),!1):!0}manageResponse(){this.hideLoadingDiv();this.boton.changeIconToChecked();this.boton.deanimateButton()}setButtons(a){this.boton=new caip_Button(a)}launch(){this.initFunction()?(this.showLoadingDiv(),this.boton.changeIconToPower(),jQuery("#"+this.buttons_id).remove(),this.launched=!0,this.resetRequest(),this.ajaxFunction()):this.launched=!1}resetRequest(){this.htmlresult=this.responseText=""}ajaxFunction(a){jQuery.ajax({url:cibelesAiPlugin.api_url,
data:{input:a.input,tokens:a.tokens,usuario:cibelesAiPlugin.nick,accion:a.id},type:"POST",dataType:"json",async:!0,beforeSend:function(){},success:function(b){if(null==b)a.ajaxFunction();else if("NOWORDS"==b.response)alert(__("Se ha quedado sin palabras disponibles, puede contratar m\u00e1s palabras en https://ai.cibeles.net/","cibeles-ai")),a.responseText="",a.manageResponse();else if(b.error)alert(b.error.message+" API OPENAI X"),a.responseText="",a.ajaxFunction();else{a.responseText+=b.texto;let c=
"";b.choices&&(c=b.choices[0].finish_reason);"length"==c?(a.input+=b.texto,a.ajaxFunction()):(console.log("fin "+a.id+": "+c),c&&"stop"==c?a.manageResponse():3<a.responseText.length?a.manageResponse():(a.responseText="",a.ajaxFunction()))}},error:function(b,c){a.responseText="";a.ajaxFunction();alert("Disculpe, existi\u00f3 un problema ajax")},complete:function(b,c){}})}showLoadingDiv(){jQuery(this.divresult).append(this.loadingDiv);jQuery(this.divresult+" #loadingDiv").css("display","block")}hideLoadingDiv(){jQuery(this.divresult+
" #loadingDiv").css("display","none")}};class caip_ResumenP extends caip_Action{constructor(){super();this.tokens=300;this.responseStartsWhith="";this.prompt=__("Genera un resumen de no m\u00e1s de 35 palabras o 300 caracteres sobre el siguiente texto en espa\u00f1ol: \n\n","cibeles-ai");this.input=this.prompt+this.contenido+"\n\n"+this.responseStartsWhith;this.alertSinContenido=__("No hay ning\u00fan texto o contenido en la entrada con la que poder generar el resumen.","cibeles-ai")}launch(){jQuery(this.divresult).html("");super.launch()}excerpt(){jQuery("#excerpt").val(this.responseText)}ajaxFunction(){super.ajaxFunction(this)}}
;class caip_Tag extends caip_Action{constructor(){super();this.tokens=300;this.responseStartsWhith="1.";this.cantidad=caip_settings.caip_numero_tags;this.originalPrompt=this.prompt=__("Una lista ordenada de 10 etiquetas sobre en siguiente texto:\n\n","cibeles-ai").replace("%d",caip_settings.caip_numero_tags);this.input=this.prompt+this.contenido+"\n\n"+this.responseStartsWhith;this.tags=[];this.selectedTags=[];this.alertSinContenido=__("No hay ning\u00fan texto o contenido en la entrada con la que poder generar los tags.",
"cibeles-ai")}launch(){this.responseStartsWhith=this.generateResponseStartsWhith(this.tags);this.prompt=this.originalPrompt.replace(caip_settings.caip_numero_tags,this.cantidad);this.cantidad=parseInt(caip_settings.caip_numero_tags)+parseInt(this.cantidad);super.launch()}generateResponseStartsWhith(a){let b="";for(let c=0;c<a.length;c++)b+=c+1+". "+a[c]+"\n",c+1==a.length&&(b+=c+1+1+".");return""==b?this.responseStartsWhith:b}tagsStringToArray(a){a=this.functions.convierteStringToArray(a);return a=
this.functions.eliminaSignosPuntuacion(a)}manageResponse(){super.manageResponse();this.responseText=this.responseStartsWhith+this.responseText;this.responseText=this.responseText.replace(/,/g,"");"."===this.responseText.charAt(this.responseText.length-1)&&(this.responseText=this.responseText.slice(0,-1));this.tagsResponse=this.tagsStringToArray(this.responseText);this.mergeTags();this.tagsResponse.forEach((a,b)=>{this.htmlresult+='<div class="tag">'+a+"</div>"});jQuery(this.divresult).append(this.htmlresult)}insertSelected(){const a=
document.querySelectorAll(".result."+this.id+" .tag.selected");this.selectedTags=Array.from(a,b=>b.textContent.trim());this.insert()}insertAll(){document.querySelectorAll(".result."+this.id+" .tag").forEach(a=>{a.classList.contains("selected")||a.classList.add("selected")});this.selectedTags=Array.from(document.querySelectorAll(".result."+this.id+" .tag.selected")).map(a=>a.textContent);this.insert()}insert(){jQuery("#new-tag-post_tag").val(this.selectedTags.join(","));jQuery(".button.tagadd").trigger("click")}mergeTags(){let a=
0;for(;a<this.tagsResponse.length;){const b=this.tagsResponse[a],c=b.toLowerCase();this.tags.some(d=>d.toLowerCase()===c)?this.tagsResponse.splice(a,1):(this.tags.push(b),a++)}}makeTagSelectable(){jQuery("."+this.id+" .tag").off("click").on("click",function(){jQuery(this).toggleClass("selected")})}ajaxFunction(){super.ajaxFunction(this)}};class caip_Titulo extends caip_Action{constructor(){super();this.alertSinContenido=__("No hay ning\u00fan texto o contenido en la entrada con la que poder generar los titulares.","cibeles-ai");this.titulares=[]}setButtons(){super.setButtons(this.id);this.buttons_id="div_button_"+this.id+"more";this.buttons_html='<div id="'+this.buttons_id+'" class="more center"></div>';this.button_more='<div id="'+this.buttons_id+'" class="more center"><div class="cibelesAi_button" onclick="caip_'+this.id+'.launch();"><a title="'+
__("Generar m\u00e1s titulares","cibeles-ai")+'">'+__("Generar m\u00e1s","cibeles-ai")+this.boton.powerIcon+"</a></div></div>";this.button_insert='<div class="insert"><div class="cibelesAi_button" onclick="caip_'+this.id+'.insertTitle(this);"><a title="'+__("Inserta el t\u00edtulo del post","cibeles-ai")+'">'+__("Insertar","cibeles-ai")+"</a></div></div>"}resetRequest(){this.titulares=[];super.resetRequest()}titularesStringToArray(a){this.titulares=this.functions.convierteStringToArray(a);return this.titulares=
this.functions.eliminaSignosPuntuacion(this.titulares)}manageResponse(){super.manageResponse();"."===this.responseText.charAt(this.responseText.length-1)&&(this.responseText=this.responseText.slice(0,-1));this.titulares=this.titularesStringToArray(this.responseText);this.titulares.forEach((a,b)=>{this.htmlresult+='<div class="titular">'+this.button_insert+a+"</div>"});jQuery(this.divresult).append(this.htmlresult).append(this.buttons_html);jQuery("#"+this.buttons_id).append(this.button_more)}insertTitle(a){a=
a.closest(".titular").cloneNode(!0);a.querySelector(".insert").innerHTML="";a=a.textContent.trim();jQuery("#TB_closeWindowButton").click();jQuery("#title").trigger("click");jQuery("#title").val(a);jQuery("#title-prompt-text").html("")}ajaxFunction(){super.ajaxFunction(this)}};class caip_Clickbait extends caip_Titulo{constructor(){super();if(caip_Clickbait.instance)return caip_Clickbait.instance;this.id="clickbait";this.divresult=".result.clickbait";this.prompt=__("Un listado de %d titulares estilo clickbait sobre el siguiente texto: \n\n","cibeles-ai").replace("%d",caip_settings.caip_numero_titulares);this.input=this.prompt+this.contenido+"\n\n";this.setButtons();caip_Clickbait.instance=this}};class caip_Resumen extends caip_ResumenP{constructor(){super();if(caip_Resumen.instance)return caip_Resumen.instance;this.id="resumen";this.divresult=".result.resumen";this.setButtons();caip_Resumen.instance=this}setButtons(){super.setButtons(this.id);this.buttons_id="div_buttons_"+this.id;this.buttons_html='<div id="'+this.buttons_id+'" class="more center"></div>';this.button_regenerar='<div class="cibelesAi_button" onclick="caip_'+this.id+'.launch();"><a title="'+__("Regenerar resumen","cibeles-ai")+
'">'+__("Regenerar","cibeles-ai")+this.boton.powerIcon+"</a></div>";this.button_excerpt='<div class="cibelesAi_button" onclick="caip_'+this.id+'.excerpt(this);"><a title="'+__("Insertar en el excerpt de la entrada","cibeles-ai")+'">'+__("Insertar en el excerpt","cibeles-ai")+"</a></div>";this.button_text='<div class="cibelesAi_button" onclick="caip_'+this.id+'.content(this);"><a title="'+__("Insertar al principio del contenido de la entrada","cibeles-ai")+'">'+__("Insertar al principio del contenido",
"cibeles-ai")+"</a></div>";this.button_copy='<div class="cibelesAi_button" onclick="caip_'+this.id+'.copiar(this);"><a title="'+__("Copiar","cibeles-ai")+'">'+__("Copiar","cibeles-ai")+"</a></div>"}excerpt(a=!1){super.excerpt();this.boton.changeIconToChecked(a)}manageResponse(){super.manageResponse();jQuery(this.divresult).append('<div class="resumenText"></div>');this.responseText=this.responseText.trim();jQuery(this.divresult+" .resumenText").append(this.responseText);jQuery(this.divresult).append(this.buttons_html);
jQuery("#"+this.buttons_id).append(this.button_regenerar+this.button_excerpt+this.button_text+this.button_copy)}content(a){if(tinyMCE&&null!=tinyMCE.activeEditor){let b=tinymce.get("content").getContent();b=b.replace(/<p class="resumenContent">.*?<\/p>/gi,"");tinymce.get("content").setContent('<p class="resumenContent">'+this.responseText+"</p>"+b);this.boton.changeIconToChecked(a)}else alert(__("Hay un problema con el edior tinyMCE, aseg\u00farese que est\u00e1 en modo visual","cibeles-ai"))}copiar(a){this.functions.copiar(this.responseText);
this.boton.changeIconToChecked(a)}};class caip_Tags extends caip_Tag{constructor(){super();if(caip_Tags.instance)return caip_Tags.instance;this.id="tags";this.divresult=".result.tags";this.setButtons();caip_Tags.instance=this}setButtons(){super.setButtons(this.id);this.buttons_id="div_buttons_"+this.id;this.buttons_html='<div id="'+this.buttons_id+'" class="more center"></div>';this.button_more='<div class="cibelesAi_button" onclick="caip_'+this.id+'.launch();"><a title="'+__("Generar m\u00e1s tags","cibeles-ai")+'">'+__("Generar m\u00e1s",
"cibeles-ai")+this.boton.powerIcon+"</a></div>";this.button_all='<div class="cibelesAi_button" onclick="caip_'+this.id+'.insertAll();"><a title="'+__("Insertar todos los tags","cibeles-ai")+'">'+__("Insertar todos","cibeles-ai")+"</a></div>";this.button_custom='<div class="cibelesAi_button" onclick="caip_'+this.id+'.insertSelected();"><a title="'+__("Insertar los tags seleccionados","cibeles-ai")+'">'+__("Insertar selecci\u00f3n","cibeles-ai")+"</a></div>"}manageResponse(){super.manageResponse();
jQuery(this.divresult).append(this.buttons_html);jQuery("#"+this.buttons_id).append(this.button_more+this.button_all+this.button_custom);this.makeTagSelectable()}insert(){super.insert();jQuery("#TB_closeWindowButton").click()}};class caip_Titular extends caip_Titulo{constructor(){super();if(caip_Titular.instance)return caip_Titular.instance;this.id="titular";this.divresult=".result.titular";this.prompt=__("Un listado de %d titulares sobre el siguiente texto: \n\n","cibeles-ai").replace("%d",caip_settings.caip_numero_titulares);this.input=this.prompt+this.contenido+"\n\n";this.setButtons();caip_Titular.instance=this}};class caip_Titularcorto extends caip_Titulo{constructor(){super();if(caip_Titularcorto.instance)return caip_Titularcorto.instance;this.id="titularcorto";this.divresult=".result.titularcorto";this.prompt=__("Un listado de %d titulares muy cortos sobre el siguiente texto: \n\n","cibeles-ai").replace("%d",caip_settings.caip_numero_titulares);this.input=this.prompt+this.contenido+"\n\n";this.setButtons();caip_Titularcorto.instance=this}};class caip_Autoexcerpt extends caip_ResumenP{constructor(){super();if(caip_Autoexcerpt.instance)return caip_Autoexcerpt.instance;this.id="autoexcerpt";this.divresult=".result.autoexcerpt";this.setButtons(this.id);caip_Autoexcerpt.instance=this}manageResponse(){super.manageResponse();jQuery(this.divresult).append('<div class="resumenText"></div>');this.responseText=this.responseText.trim();jQuery(this.divresult+" .resumenText").append(this.responseText);this.launched=!1;this.excerpt()}};class caip_Autotags extends caip_Tag{constructor(){super();if(caip_Autotags.instance)return caip_Autotags.instance;this.id="autotags";this.divresult=".result.autotags";this.setButtons(this.id);caip_Autotags.instance=this}manageResponse(){super.manageResponse();this.insertAll();this.launched=!1}};
